#!/bin/bash
#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
PATH=build/bin/:${PATH}

# Takes in 4 arguments
# 1. Output doc file
# 2. Preamble Text File
# 3. Postscript File
# 4. Array of commands
generateHelpText() {
    local DOC="$1"
    local preamble="$2"
    local postscript="$3"
    # Shift three times to get to array
    shift
    shift
    shift

    cat <<EOF > "$DOC"
<!---
 File generated by $(basename "$0"). DO NOT EDIT.
 Please make changes to preamble and postscript wrappers as appropriate.
 --->

EOF
    cat "$preamble" >> "$DOC"

    local code_delim='```'
    local commands=("$@")
    for x in "${commands[@]}" ; do
      cat <<EOD >> "$DOC"

## $x
$code_delim
$($x --help 2>&1 | sed -E 's/[[:space:]]+$//g')
$code_delim

EOD
    done

    cat "$postscript" >> "$DOC"
}

checkHelpTextCurrent() {
  local doc="$1"
  shift

  local tempfile
  tempfile="$(mktemp -t "$(basename "$1")".XXXXX)" || exit 1

  generateHelpText "$tempfile" "$@"
  if ! diff -u "$doc" "$tempfile"; then
    echo "The command line help docs are out of date and need to be regenerated, see docs/source/docs_guide.md for more details."
    exit 2
  fi

  rm "$tempfile"
}

generateOrCheck() {
  if [ "$action" == "generate" ]; then
    generateHelpText "$@"
  else
    checkHelpTextCurrent "$@"
  fi
}

action="${1:-generate}"

commands=("peer version")
generateOrCheck \
        docs/source/commands/peerversion.md \
        docs/wrappers/peer_version_preamble.md \
        docs/wrappers/license_postscript.md \
        "${commands[@]}"

commands=("peer node pause" "peer node rebuild-dbs" "peer node reset" "peer node resume" "peer node rollback" "peer node start" "peer node unjoin" "peer node upgrade-dbs")
generateOrCheck \
        docs/source/commands/peernode.md \
        docs/wrappers/peer_node_preamble.md \
        docs/wrappers/peer_node_postscript.md \
        "${commands[@]}"

commands=("cli version")
generateOrCheck \
        docs/source/commands/cliversion.md \
        docs/wrappers/cli_version_preamble.md \
        docs/wrappers/license_postscript.md \
        "${commands[@]}"

commands=("cli chaincode invoke" "cli chaincode query")
generateOrCheck \
        docs/source/commands/clichaincode.md \
        docs/wrappers/cli_chaincode_preamble.md \
        docs/wrappers/cli_chaincode_postscript.md \
        "${commands[@]}"

commands=("cli lifecycle" "cli lifecycle chaincode" "cli lifecycle chaincode package" "cli lifecycle chaincode install" "cli lifecycle chaincode queryinstalled" "cli lifecycle chaincode getinstalledpackage" "cli lifecycle chaincode calculatepackageid" "cli lifecycle chaincode approveformyorg" "cli lifecycle chaincode queryapproved" "cli lifecycle chaincode checkcommitreadiness" "cli lifecycle chaincode commit" "cli lifecycle chaincode querycommitted")
generateOrCheck \
        docs/source/commands/clilifecycle.md \
        docs/wrappers/cli_lifecycle_chaincode_preamble.md \
        docs/wrappers/cli_lifecycle_chaincode_postscript.md \
        "${commands[@]}"

commands=("cli channel" "cli channel create" "cli channel fetch" "cli channel getinfo" "cli channel join" "cli channel joinbysnapshot" "cli channel joinbysnapshotstatus" "cli channel list" "cli channel signconfigtx" "cli channel update")
generateOrCheck \
        docs/source/commands/clichannel.md \
        docs/wrappers/cli_channel_preamble.md \
        docs/wrappers/cli_channel_postscript.md \
        "${commands[@]}"

commands=("cli snapshot cancelrequest" "cli snapshot listpending" "cli snapshot submitrequest")
generateOrCheck \
        docs/source/commands/clisnapshot.md \
        docs/wrappers/cli_snapshot_preamble.md \
        docs/wrappers/cli_snapshot_postscript.md \
        "${commands[@]}"

commands=("configtxgen")
generateOrCheck \
        docs/source/commands/configtxgen.md \
        docs/wrappers/configtxgen_preamble.md \
        docs/wrappers/configtxgen_postscript.md \
        "${commands[@]}"

commands=("cryptogen help" "cryptogen generate" "cryptogen showtemplate" "cryptogen extend" "cryptogen version")
generateOrCheck \
        docs/source/commands/cryptogen.md \
        docs/wrappers/cryptogen_preamble.md \
        docs/wrappers/cryptogen_postscript.md \
        "${commands[@]}"

commands=("configtxlator start" "configtxlator proto_encode" "configtxlator proto_decode" "configtxlator compute_update" "configtxlator version")
generateOrCheck \
        docs/source/commands/configtxlator.md \
        docs/wrappers/configtxlator_preamble.md \
        docs/wrappers/configtxlator_postscript.md \
        "${commands[@]}"

commands=("osnadmin channel" "osnadmin channel join" "osnadmin channel list" "osnadmin channel remove" "osnadmin channel update" "osnadmin channel fetch")
generateOrCheck \
        docs/source/commands/osnadminchannel.md \
        docs/wrappers/osnadmin_channel_preamble.md \
        docs/wrappers/osnadmin_channel_postscript.md \
        "${commands[@]}"

commands=("ledgerutil compare" "ledgerutil identifytxs" "ledgerutil verify")
generateOrCheck \
        docs/source/commands/ledgerutil.md \
        docs/wrappers/ledgerutil_preamble.md \
        docs/wrappers/ledgerutil_postscript.md \
        "${commands[@]}"

exit
